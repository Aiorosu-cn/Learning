[TOC]

参考链接：

[【骨骼动画】UE的IK解决方案 ](https://zhuanlan.zhihu.com/p/446995093)

[使用重定位后的动画 | 虚幻引擎文档 (unrealengine.com)](https://docs.unrealengine.com/4.27/zh-CN/AnimatingObjects/SkeletalMeshAnimation/AnimHowTo/Retargeting/)

[UE4-同骨架的动画重定向_同一骨骼动画只换模型_懒猫睡大觉的博客-CSDN博客](https://blog.csdn.net/lei_7103/article/details/109080926)

[Maya中的IK和FK怎么理解](https://www.bilibili.com/read/cv3549745)

# 重定向（重定位）的意义

UE4 对重定位的定义：

> 动画数据使用了原始骨骼网格定义骨架资产的比例，所以使用该骨架资产但有不同比例的其他任何骨骼网格（例如比原始网格短得多的网格）都需要经过重定位才能正确工作。如果不经过这一步，具有不同比例的骨骼网格会尝试使用原始网格的平移数据，导致看到各种错误。

很多时候，我们控制的人物，并没有我们想要的动画资源，这时候就需要使用第三方的动画。但是想要给人物添加动画，必须使人物骨骼与动画的人物骨骼相对应，这里就需要用到重定向。

重定向一般用在下面两个场景：

- 使用不同骨架的模型可以使用同一套动画资源，比如小白人可以播放第三方骨骼动画，其他骨骼可以播放小白人动画，是一个双向的好处。

- 使用相同骨架的角色，如果体型不同，做同一套动画时，动画可能会扭曲。这个时候也需要重定向来修正这种扭曲。

> 如果角色骨架相同但是结构不同，比如多了个尾巴，也可以不使用重定向。
>
> 根据骨架的定义，高大的模型和矮小的模型，虽然使用了同一个骨架，但是高大模型实际的骨架中，存储的骨骼平移量应该更大的。

重定位操作上有两种工作流，使用相同骨架的重定位和使用不用骨架的重定位。



## 骨骼重定位的设置

**骨架编辑器** 中的骨架树提供了几个设置，用于更改处理骨骼之间平移重定位的方式。有 3 种不同设置可用于骨骼平移重定位：

- **Animation（动画）**——骨骼平移来自动画数据，不做改变。
  - 含义：动画播放时，骨骼的位移信息完全来自于动画。
  - 效果：模型完全 听从于动画，如果形态有差异，人物播放动画整体会变形，就是图中的收肩耸肩情况。如果是源模型 白色骨骼与浅绿色骨骼重合。
- **Skeleton（骨架）**——骨骼平移来自目标骨架的绑定姿势。
  - 含义：使用模型自身骨架
  - 效果：人物大小保持原样（不再收肩耸肩），但是动画播放时，人物模型上半身僵硬，没有动作。
- **比例动画（AnimationScaled）**——骨骼平移来自动画数据，但按骨架的比例调整。这是目标骨架（播放动画的骨架）与源骨架（制作动画的骨架）的骨骼长度之比。
  - 含义：动画播放时，骨骼的位移信息一部分来自于动画，一部分来自于模型
  - 效果：动画比较符合身型，上半身也会有动作。

> 使用同一副骨骼，但是身型（胖瘦的情况）有差异的模型上，可以 使用缩放动画模式 进行重定向操作，从而达到动画的复用。对于身高高度存在差异需要使用其他方法。

通常我们需要对两足生物使用这些设置：

- 根骨骼、IK骨骼、武器骨骼和任何一种将使用动画模式的标记。
- 骨盆将使用比例动画，以确保其在正确的高度，同时仍能动作。
  - 您希望平移和重定位动画的其他任何骨骼也应该使用比例动画。
- 所有其他骨骼都应使用骨架。它们将使用来自目标骨架的静态平移。

# 相同骨架使用骨骼重定位

打开需要重定位的角色，找到骨骼树，把骨骼树设置为显示重定向选项，鼠标悬停到重定向的下拉列表下，可以看到重定向的操作说明。

## 设置平移重定向骨架

右键根骨骼选择递归设置平移重定向骨架。所有其他骨骼都应使用骨架。它们将使用来自目标骨架的静态平移。

如果设置为骨架，那么骨骼平移来自目标骨架的绑定姿势。此设置可以确保所有骨骼都使用该骨架的静态平移（稍后我们将修改特定骨骼以用于重定位）。



## 设置比例动画

找到 **骨盆（Pelvis）** 骨骼或与之相当的骨骼，然后单击下拉框并选择 **比例动画（AnimationScaled）**。

此设置可以确保该骨骼位于合适的高度，同时仍能活动。对于你希望平移能够被制成动画和重定位的任何其他骨骼，你也都应使用此设置。



## 设置为动画

找到 **根（Root）** 骨骼、**IK** 骨骼、你可能使用了的 **武器（Weapon）** 骨骼或其他标记式骨骼并将它们设置为 **动画（Animation）**。

通过将 **动画（Animation）** 用作"骨骼平移重定位模式（Bone Translation Retargeting Mode）"，骨骼平移就会来自动画数据本身，不会更改。

> FK正向动力学,是根据父关节的旋转来计算得出每个子关节的位置
>
> 应用: 走动时手臂的摆动就是用FK
>
> IK反向动力学,是根据末端子关节的位置移动来计算得出每个父关节的旋转
>
> 应用: 下蹲时双脚固定在地面上用的就是IK

IK骨骼是一种使用反向动力学（Inverse Kinematics）对骨骼进行动画处理的方式，它可以通过定位骨骼链中的末端来自动调整其他骨骼的位置和旋转。IK骨骼通常用于控制角色的四肢、手指或其他需要贴合目标对象的部位。



# 动画重定位

不同的骨架之间重定位，是创建一个文件（UE叫做**Rig**，姑且理解为绑定），里面记录了动画所用的骨架和当前骨架的一个平移转换关系。这样就不用每个动画都和当前骨架做一个转换，节约空间和效率。

UE中，使用了重定位管理器来创建和管理Rig。



# 不同骨架使用动画重定位

## 源骨骼绑定Rig

- 双击小白人的骨骼,打开重定向管理器**Retargetmanager**,进入重定向界面。

- 在**select rig** 选择为  humanoid（人形），因为UE4的人形骨骼就是根据小白人做的，所以直接自动匹配了所有骨骼，不需要选择。

- Rig绑定左边是Rig，右边是映射的骨骼。

- 点击保存

> Rig可以通过右键骨骼创建，蓝图创建的是Control Rig ，在Control Rig编辑器中，可以使用层级面板（Hierarchy Panel）来添加、删除和修改骨骼节点和控制器节点。



## 新骨骼绑定Rig

新骨骼在重定向管理器中也添加相同的Rig，UE4会自动填充名字对应的骨骼，但是也需要我们手动检查是否是一致的。

高级选项可以绑定手指，脚趾，IK骨骼等小的骨骼。





## 对需要的动画重定向

右键动画资源，选择`重定位动画资产->复制并重定向`，会出现一个窗口，左边是源骨骼，选择需要重定向的骨骼。

不要担心视口偏移，只要两个骨骼的初始动作一样就行。



# mixamo上的骨骼重定位

## 把新骨骼动画配置到小白人上

- 选择导入的动画骨骼,右键重定向**mixamo 骨骼资源**(装了插件)--选择小白人骨骼;
- 选择导入的动画,右键--重定向动画资源--复制动画资源并且重定向--选择小白人--点击**retarget重定向**;
- 此时生成一个新的小白人动画;



## 把小白人动作配置到新的模型

- 动画资源-右键(装了插件)--选择小白人骨骼,小白人就可以跳舞了

- 模型使用小白人动画(此时骨骼已经匹配)

  - 小白人动画,右键资源-选择模型骨骼;

> 还有一种外部软件  mixamoConverter,可以在外部转换然后导入;









